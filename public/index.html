<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clawd Task Board</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121a33;
      --muted: #9aa6c6;
      --text: #e7ecff;
      --accent: #7aa2ff;
      --border: rgba(255,255,255,0.10);
      --card: rgba(255,255,255,0.04);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1000px 600px at 20% -10%, rgba(122,162,255,0.25), transparent 60%),
                  radial-gradient(800px 500px at 90% 10%, rgba(74,222,128,0.12), transparent 55%),
                  var(--bg);
      color: var(--text);
    }
    header {
      padding: 18px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      backdrop-filter: blur(10px);
      background: rgba(11,16,32,0.75);
      z-index: 10;
    }
    .wrap { max-width: 1200px; margin: 0 auto; }
    h1 { margin: 0; font-size: 16px; }
    .sub { margin-top: 4px; font-size: 12px; color: var(--muted); }

    main { padding: 16px 18px 30px; }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 950px) {
      .grid { grid-template-columns: 1fr 1fr 1fr; }
    }

    .col {
      background: rgba(18,26,51,0.75);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      min-height: 300px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .colTitle {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .colTitle .name { font-weight: 900; font-size: 13px; }
    .pill { font-size: 12px; color: var(--muted); }

    .card {
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .title { font-weight: 900; font-size: 13px; }
    .meta { margin-top: 6px; font-size: 12px; color: var(--muted); line-height: 1.35; }
    .tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .tag {
      font-size: 12px;
      color: #cfe0ff;
      background: rgba(122,162,255,0.12);
      border: 1px solid rgba(122,162,255,0.18);
      padding: 4px 8px;
      border-radius: 999px;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }
    button {
      border: 0;
      border-radius: 12px;
      padding: 8px 10px;
      background: var(--accent);
      color: #08102a;
      font-weight: 800;
      cursor: pointer;
    }
    button.secondary {
      background: rgba(255,255,255,0.08);
      color: var(--text);
      font-weight: 700;
      border: 1px solid rgba(255,255,255,0.12);
    }
    input, textarea, select {
      width: 100%;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 10px;
      padding: 9px;
      color: var(--text);
      outline: none;
      font-size: 13px;
    }
    textarea { min-height: 80px; resize: vertical; }

    .modalBack {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
    }
    .modal {
      width: min(720px, 100%);
      background: rgba(18,26,51,0.96);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 700px) { .row { grid-template-columns: 1fr 1fr; } }
    .muted { color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
      <div>
        <h1>Clawd Task Board</h1>
        <div class="sub">Simple project board: backlog → in progress → done.</div>
      </div>
      <div class="toolbar">
        <button class="secondary" id="refreshBtn">Refresh</button>
        <button id="newBtn">New task</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="grid">
      <section class="col" data-status="backlog">
        <div class="colTitle"><div class="name">Backlog</div><div class="pill" id="count_backlog">0</div></div>
        <div id="list_backlog"></div>
      </section>
      <section class="col" data-status="in_progress">
        <div class="colTitle"><div class="name">In progress</div><div class="pill" id="count_in_progress">0</div></div>
        <div id="list_in_progress"></div>
      </section>
      <section class="col" data-status="done">
        <div class="colTitle"><div class="name">Completed</div><div class="pill" id="count_done">0</div></div>
        <div id="list_done"></div>
      </section>
    </div>
  </div>
</main>

<div class="modalBack" id="modalBack">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:baseline;">
      <div>
        <div class="title" id="modalTitle">New task</div>
        <div class="muted">Write in plain English. One task = one outcome.</div>
      </div>
      <button class="secondary" id="closeBtn">Close</button>
    </div>
    <div style="height:10px"></div>

    <div class="row">
      <div>
        <div class="muted">Status</div>
        <select id="t_status">
          <option value="backlog">backlog</option>
          <option value="in_progress">in_progress</option>
          <option value="blocked">blocked</option>
          <option value="done">done</option>
        </select>
      </div>
      <div>
        <div class="muted">Priority (1=highest)</div>
        <input id="t_priority" type="number" min="1" max="9" value="3" />
      </div>
    </div>

    <div style="margin-top:10px;">
      <div class="muted">Title</div>
      <input id="t_title" placeholder="e.g., Build shortlist of Canadian meat-stick co-packers" />
    </div>

    <div style="margin-top:10px;">
      <div class="muted">Summary (optional)</div>
      <textarea id="t_summary" placeholder="What success looks like / constraints / links..." ></textarea>
    </div>

    <div style="margin-top:10px;">
      <div class="muted">Last update (optional)</div>
      <textarea id="t_last" placeholder="Short log line. Example: Waiting on: your answer about beef-only + stick size." ></textarea>
    </div>

    <div style="margin-top:10px;">
      <div class="muted">Tags (comma separated)</div>
      <input id="t_tags" placeholder="meat-sticks, copacker" />
    </div>

    <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
      <button id="saveBtn">Save</button>
      <div class="muted" id="saveStatus"></div>
      <input type="hidden" id="t_id" />
    </div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  async function api(path, opts={}) {
    const r = await fetch(path, opts);
    return r;
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  function parseTags(str){
    return String(str||'').split(',').map(s=>s.trim()).filter(Boolean);
  }

  function openModal(task=null){
    $('modalBack').style.display = 'flex';
    $('saveStatus').textContent='';
    if(!task){
      $('modalTitle').textContent = 'New task';
      $('t_id').value='';
      $('t_status').value='backlog';
      $('t_priority').value='3';
      $('t_title').value='';
      $('t_summary').value='';
      $('t_last').value='';
      $('t_tags').value='';
      return;
    }
    $('modalTitle').textContent = 'Edit task';
    $('t_id').value=task.id;
    $('t_status').value=task.status;
    $('t_priority').value=task.priority ?? 3;
    $('t_title').value=task.title || '';
    $('t_summary').value=task.summary || '';
    $('t_last').value=task.last_update || '';
    $('t_tags').value=(task.tags||[]).join(', ');
  }
  function closeModal(){ $('modalBack').style.display='none'; }

  function render(tasks){
    const groups = { backlog: [], in_progress: [], done: [], blocked: [] };
    for(const t of tasks){
      (groups[t.status] || groups.backlog).push(t);
    }

    $('count_backlog').textContent = groups.backlog.length;
    $('count_in_progress').textContent = groups.in_progress.length + (groups.blocked.length ? ` (+${groups.blocked.length} blocked)` : '');
    $('count_done').textContent = groups.done.length;

    $('list_backlog').innerHTML='';
    $('list_in_progress').innerHTML='';
    $('list_done').innerHTML='';

    function card(t){
      const div = document.createElement('div');
      div.className='card';
      const updated = t.updated_at ? new Date(t.updated_at).toLocaleString() : '';
      const statusLine = t.status === 'blocked' ? `<div class="meta" style="color:#fbbf24;font-weight:800;">Blocked</div>` : '';
      div.innerHTML = `
        <div class="title">${escapeHtml(t.title)}</div>
        ${statusLine}
        ${t.summary ? `<div class="meta">${escapeHtml(t.summary)}</div>` : ''}
        ${t.last_update ? `<div class="meta"><b>Update:</b> ${escapeHtml(t.last_update)}</div>` : ''}
        <div class="meta">Last touched: ${escapeHtml(updated)} • Priority: ${escapeHtml(t.priority ?? 3)}</div>
        ${(t.tags && t.tags.length) ? `<div class="tags">${t.tags.map(x=>`<span class="tag">${escapeHtml(x)}</span>`).join('')}</div>` : ''}
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap: wrap;">
          <button class="secondary" data-edit="${t.id}">Edit</button>
          <button class="secondary" data-move="in_progress" data-id="${t.id}">→ In progress</button>
          <button class="secondary" data-move="done" data-id="${t.id}">✓ Done</button>
        </div>
      `;
      return div;
    }

    for(const t of groups.backlog) $('list_backlog').appendChild(card(t));
    for(const t of [...groups.in_progress, ...groups.blocked]) $('list_in_progress').appendChild(card(t));
    for(const t of groups.done) $('list_done').appendChild(card(t));

    document.querySelectorAll('[data-edit]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = Number(btn.getAttribute('data-edit'));
        const task = tasks.find(x => x.id === id);
        openModal(task);
      })
    });
    document.querySelectorAll('[data-move]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = Number(btn.getAttribute('data-id'));
        const status = btn.getAttribute('data-move');
        const task = tasks.find(x => x.id === id);
        if(!task) return;
        await saveTask({ ...task, status, last_update: task.last_update || '' });
        await refresh();
      })
    });
  }

  async function refresh(){
    const r = await api('/api/tasks');
    if(!r.ok){
      alert('Failed to load tasks. Check Netlify function logs.');
      return;
    }
    const data = await r.json();
    render(data.rows || []);
  }

  async function saveTask(taskOverride=null){
    const payload = taskOverride || {
      id: $('t_id').value ? Number($('t_id').value) : undefined,
      status: $('t_status').value,
      priority: Number($('t_priority').value || 3),
      title: $('t_title').value,
      summary: $('t_summary').value,
      last_update: $('t_last').value,
      tags: parseTags($('t_tags').value),
    };

    $('saveStatus').textContent = 'Saving…';
    const r = await api('/api/tasks', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if(!r.ok){
      $('saveStatus').textContent = 'Error saving.';
      return false;
    }
    $('saveStatus').textContent = 'Saved.';
    return true;
  }

  $('refreshBtn').addEventListener('click', refresh);
  $('newBtn').addEventListener('click', () => openModal(null));
  $('closeBtn').addEventListener('click', closeModal);
  $('modalBack').addEventListener('click', (e) => { if(e.target.id==='modalBack') closeModal(); });
  $('saveBtn').addEventListener('click', async () => {
    const ok = await saveTask();
    if(ok){ closeModal(); await refresh(); }
  });

  refresh();
</script>
</body>
</html>
